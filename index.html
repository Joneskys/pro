<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Institutional Stock Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#0b1220; --panel:#020617; --border:#1f2937; --text:#e5e7eb;
  --green:#22c55e; --red:#ef4444; --orange:#f59e0b; --muted:#94a3b8;
}
body{margin:0;background:#020617;color:var(--text);font-family:system-ui}
header{position:sticky;top:0;background:#020617;padding:8px;z-index:20}
.controls{display:flex;flex-wrap:wrap;gap:6px}
input,button,select{background:#0f172a;color:white;border:1px solid #1f2937;padding:6px;border-radius:6px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #1f2937;padding:4px;text-align:center}
th{background:#020617;position:sticky;top:55px}
tr:nth-child(even){background:#0f172a}
.green{color:#22c55e;font-weight:800}
.red{color:#ef4444;font-weight:800}
.orange{color:#f59e0b;font-weight:800}
.bold{font-weight:800}
.trend{font-size:18px;font-weight:900}
td:first-child,th:first-child{position:sticky;left:0;background:#020617}
</style>
</head>
<body>

<header>
  <div class="controls">
    <input type="date" id="date">
    <button onclick="render()">Submit</button>
    <input id="search" placeholder="Search..." oninput="render()">
    <button onclick="filter='buy';render()">Only Buy</button>
    <button onclick="filter='sell';render()">Only Sell</button>
    <button onclick="filter='all';render()">All</button>
    <select id="sort" onchange="render()">
      <option value="">Sort</option>
      <option value="volDesc">Volume â†“</option>
      <option value="volAsc">Volume â†‘</option>
      <option value="rsiDesc">RSI â†“</option>
      <option value="rsiAsc">RSI â†‘</option>
      <option value="priceDesc">Price â†“</option>
      <option value="priceAsc">Price â†‘</option>
    </select>
    <input id="newStock" placeholder="Add stock">
    <button onclick="addStock()">Add</button>
    <button onclick="screenshot()">ðŸ“¸</button>
  </div>
</header>

<table>
<thead>
<tr>
<th>Trend</th><th>Stock</th><th>Live</th><th>Today</th><th>Vol(L)</th>
<th>SL</th><th>Target</th><th>1W</th><th>1M</th><th>RSI</th>
<th>Support</th><th>Resistance</th><th>EMA21</th><th>EMA9</th><th>Signal</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
const WORKER="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const STOCK_API=s=>`${WORKER}?symbol=${s}`;

const TELEGRAM_BOT="PASTE_BOT_TOKEN";
const TELEGRAM_CHAT="PASTE_CHAT_ID";

let STOCKS=JSON.parse(localStorage.getItem("stocks")||"[]");
if(STOCKS.length===0){
STOCKS=["SBIN","HDFCBANK","TCS","RVNL","IDEA"];
}

let DB={},filter="all";

function saveStocks(){localStorage.setItem("stocks",JSON.stringify(STOCKS));}

function addStock(){
 let s=newStock.value.toUpperCase().trim();
 if(s&&!STOCKS.includes(s)){STOCKS.push(s);saveStocks();loadStock(s);}
 newStock.value="";
}

async function loadStock(s){
 try{
  let j=await (await fetch(STOCK_API(s))).json();
  let r=j.chart.result[0],q=r.indicators.quote[0];
  DB[s]=r.timestamp.map((t,i)=>({
   date:new Date(t*1000).toISOString().slice(0,10),
   open:q.open[i],high:q.high[i],low:q.low[i],close:q.close[i],volume:q.volume[i]||0
  })).filter(x=>x.close);
 }catch{DB[s]=[]}
}

const EMA=(a,p)=>{let k=2/(p+1),e=a[0];a.forEach(v=>e=v*k+e*(1-k));return e;}
const RSI=a=>{let g=0,l=0;for(let i=1;i<15;i++){let d=a[i]-a[i-1];d>0?g+=d:l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

function supertrend(data,period=10,mult=3){
 let atr=[],st=[];
 for(let i=1;i<data.length;i++){
  let tr=Math.max(data[i].high-data[i].low,
    Math.abs(data[i].high-data[i-1].close),
    Math.abs(data[i].low-data[i-1].close));
  atr.push(tr);
 }
 let avg=atr.slice(-period).reduce((a,b)=>a+b,0)/period;
 let mid=(data.at(-1).high+data.at(-1).low)/2;
 let upper=mid+mult*avg;
 let lower=mid-mult*avg;
 return data.at(-1).close>upper?"BUY":data.at(-1).close<lower?"SELL":"HOLD";
}

function vwap(data){
 let pv=0,v=0;
 for(let d of data){pv+=d.close*d.volume;v+=d.volume;}
 return pv/v;
}

function sendTelegram(msg){
 if(!TELEGRAM_BOT)return;
 fetch(`https://api.telegram.org/bot${TELEGRAM_BOT}/sendMessage?chat_id=${TELEGRAM_CHAT}&text=${encodeURIComponent(msg)}`);
}

function render(){
 let q=search.value.toLowerCase();
 let rows=[];

 for(let s of STOCKS){
  let d=DB[s]; if(!d||d.length<30)continue;
  if(q&&!s.toLowerCase().includes(q))continue;

  let t=d.at(-1),cl=d.map(x=>x.close);
  let e9=EMA(cl.slice(-9),9),e21=EMA(cl.slice(-21),21),rsi=RSI(cl.slice(-15));
  let sup=Math.min(...d.slice(-20).map(x=>x.low));
  let res=Math.max(...d.slice(-20).map(x=>x.high));
  let sig=e9>e21&&rsi>55?"BUY":e9<e21&&rsi<45?"SELL":"HOLD";

  let atr=Math.abs(t.high-t.low);
  let entry=t.close;
  let sl=sig==="BUY"?entry-1.2*atr:entry+1.2*atr;
  let tgt=sig==="BUY"?entry+1.6*atr:entry-1.6*atr;

  let trend = sig==="BUY"?"<span class='trend green'>â†‘</span>":sig==="SELL"?"<span class='trend red'>â†“</span>":"<span class='trend orange'>â†’</span>";

  rows.push({s,entry,t,sup,res,e21,e9,rsi,sig,sl,tgt,trend});
 }

 tbody.innerHTML=rows.map(r=>`
<tr>
<td>${r.trend}</td>
<td class="bold ${r.sig==="BUY"?"green":r.sig==="SELL"?"red":""}" onclick="openTrade('${r.s}',${r.entry.toFixed(2)},${r.sl.toFixed(2)},${r.tgt.toFixed(2)})">${r.s}</td>
<td>${r.entry.toFixed(2)}</td>
<td class="small">L:${r.t.low.toFixed(1)} H:${r.t.high.toFixed(1)}</td>
<td>${Math.round(r.t.volume/100000)}</td>
<td>${r.sl.toFixed(2)}</td>
<td>${r.tgt.toFixed(2)}</td>
<td>${r.rsi.toFixed(1)}</td>
<td>${r.sup.toFixed(2)}</td>
<td>${r.res.toFixed(2)}</td>
<td>${r.e21.toFixed(2)}</td>
<td>${r.e9.toFixed(2)}</td>
<td class="${r.sig==='BUY'?'green':r.sig==='SELL'?'red':'orange'}">${r.sig}</td>
</tr>`).join("");
}

function openTrade(s,e,sl,t){window.open(`trade.html?stock=${s}&entry=${e}&sl=${sl}&target=${t}`)}

function screenshot(){
 html2canvas(document.body).then(c=>{
  let d=new Date();
  let name=d.toISOString().slice(0,10).replace(/-/g,"")+"_"+d.getHours()+d.getMinutes()+"_STOCKS.png";
  let a=document.createElement("a");a.download=name;a.href=c.toDataURL();a.click();
 });
}

async function init(){for(let s of STOCKS)await loadStock(s);render();setInterval(render,60000);}
init();
</script>
</body>
</html>
