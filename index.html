<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Professional Trading Dashboard</title>

<style>
:root{
  --bg:#020617; --panel:#0b1220; --border:#1f2937; --text:#e5e7eb;
  --green:#22c55e; --red:#ef4444; --orange:#f59e0b; --muted:#94a3b8;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(180deg,#020617,#0b1220);color:var(--text);font-family:system-ui}
header{position:sticky;top:0;background:#020617;border-bottom:1px solid var(--border);padding:10px;z-index:10}
.controls{display:flex;flex-wrap:wrap;gap:6px}
input,select,button{background:#0f172a;color:white;border:1px solid var(--border);padding:6px 10px;border-radius:10px}
button{cursor:pointer}
.table-wrap{max-height:75vh;overflow:auto;border:1px solid var(--border);border-radius:12px}
table{width:100%;border-collapse:collapse;font-size:12px;min-width:1300px}
th,td{border:1px solid var(--border);padding:6px;text-align:center}
th{position:sticky;top:0;background:#020617}
tr:nth-child(even){background:#0f172a}
.green{color:var(--green);font-weight:bold}
.red{color:var(--red);font-weight:bold}
.orange{color:var(--orange);font-weight:bold}
.bold{font-weight:800}
.small{font-size:11px;color:var(--muted)}
.tradeBtn{background:#111827;border:1px solid var(--border);border-radius:999px;padding:4px 10px}
.popup{position:fixed;bottom:20px;right:20px;background:#020617;border:1px solid var(--border);border-radius:12px;padding:10px;display:none}
</style>
</head>
<body>

<header>
  <div class="controls">
    <input type="date" id="date">
    <button onclick="render()">Submit</button>

    <input id="search" placeholder="Search stock" oninput="render()">
    <button onclick="filter='buy';render()">Only Buy</button>
    <button onclick="filter='sell';render()">Only Sell</button>
    <button onclick="filter='all';render()">All</button>

    <select id="sort" onchange="render()">
      <option value="">Sort</option>
      <option value="volDesc">Volume â†“</option>
      <option value="rsiDesc">RSI â†“</option>
      <option value="priceDesc">Price â†“</option>
    </select>

    <input id="newStock" placeholder="Add stock">
    <button onclick="addStock()">Add</button>

    <button onclick="takeScreenshot()">ðŸ“¸ Screenshot</button>
    <button onclick="muted=!muted">Mute</button>
  </div>
  <div class="small">Last refresh: <span id="time"></span></div>
</header>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th><th>Trend</th>
<th>Signal</th><th>Entry</th><th>SL</th><th>Target</th><th>Trade</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<div class="popup" id="popup">
  <div id="popupText"></div>
  <button onclick="popup.style.display='none'">Close</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
const WORKER="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const API=s=>`${WORKER}?symbol=${s}`;

let STOCKS=["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];

let DB={},filter="all",muted=false,lastSignals={};

function parseWorker(j){
 try{
  let r=j.chart.result[0],q=r.indicators.quote[0];
  return r.timestamp.map((t,i)=>({
    date:new Date(t*1000).toISOString().slice(0,10),
    open:q.open[i],high:q.high[i],low:q.low[i],
    close:q.close[i],volume:q.volume?.[i]||0
  })).filter(x=>x.close);
 }catch{return [];}
}

async function loadStock(s){
 try{
  DB[s]=parseWorker(await (await fetch(API(s))).json());
 }catch{}
}

const EMA=(a,p)=>{let k=2/(p+1),e=a[0];a.forEach(v=>e=v*k+e*(1-k));return e;}
const RSI=a=>{let g=0,l=0;for(let i=1;i<=14;i++){let d=a[i]-a[i-1];d>0?g+=d:l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

function render(){
 time.textContent=new Date().toLocaleTimeString();
 let q=search.value.toLowerCase();
 let rows=[];

 for(let s of STOCKS){
  let d=DB[s]; if(!d||d.length<30)continue;
  if(q&&!s.toLowerCase().includes(q))continue;

  let sel=date.value;
  let data=sel?d.filter(x=>x.date<=sel):d;
  if(data.length<30)continue;

  let t=data.at(-1);
  let cl=data.map(x=>x.close);
  let e9=EMA(cl.slice(-9),9);
  let e21=EMA(cl.slice(-21),21);
  let rsi=RSI(cl.slice(-15));
  let w=data.slice(-6), m=data.slice(-21);
  let sup=Math.min(...m.map(x=>x.low));
  let res=Math.max(...m.map(x=>x.high));
  let sig=e9>e21&&rsi>60?"BUY":e9<e21&&rsi<40?"SELL":"HOLD";

  if(filter==='buy'&&sig!=='BUY')continue;
  if(filter==='sell'&&sig!=='SELL')continue;

  let entry=t.close;
  let sl=sig==="BUY"?sup:res;
  let tgt=sig==="BUY"?entry+(entry-sup):entry-(res-entry);
  let volL=Math.round(t.volume/100000);

  if(sig!=="HOLD" && lastSignals[s]!==sig){
    lastSignals[s]=sig;
    popupText.innerHTML=`<b class="${sig==="BUY"?'green':'red'}">${s} ${sig}</b>`;
    popup.style.display="block";
    if(!muted){
      let a=new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
      a.play(); setTimeout(()=>{a.pause()},3000);
    }
  }

  rows.push({s,t,w,m,rsi,e9,e21,sup,res,sig,entry,sl,tgt,volL});
 }

 let sortv=sort.value;
 if(sortv==='volDesc')rows.sort((a,b)=>b.volL-a.volL);
 if(sortv==='rsiDesc')rows.sort((a,b)=>b.rsi-a.rsi);
 if(sortv==='priceDesc')rows.sort((a,b)=>b.entry-a.entry);

 tbody.innerHTML=rows.map(r=>`
<tr>
<td class="bold ${r.sig==='BUY'?'green':r.sig==='SELL'?'red':''}">${r.s}</td>
<td>${r.entry.toFixed(2)}</td>
<td class="small">L:${r.t.low.toFixed(1)} H:${r.t.high.toFixed(1)}</td>
<td class="small">L:${Math.min(...r.w.map(x=>x.low)).toFixed(1)} H:${Math.max(...r.w.map(x=>x.high)).toFixed(1)}</td>
<td>${r.volL}</td>
<td class="small">L:${Math.min(...r.m.map(x=>x.low)).toFixed(1)} H:${Math.max(...r.m.map(x=>x.high)).toFixed(1)}</td>
<td>${r.rsi.toFixed(1)}</td>
<td>${r.e9.toFixed(2)}</td>
<td>${r.e21.toFixed(2)}</td>
<td>${r.sup.toFixed(2)}</td>
<td>${r.res.toFixed(2)}</td>
<td>${r.e9>r.e21?'Uptrend':'Downtrend'}</td>
<td class="${r.sig==='BUY'?'green':r.sig==='SELL'?'red':'orange'}">${r.sig}</td>
<td>${r.entry.toFixed(2)}</td>
<td>${r.sl.toFixed(2)}</td>
<td>${r.tgt.toFixed(2)}</td>
<td><button class="tradeBtn" onclick="openTrade('${r.s}',${r.entry},${r.sl},${r.tgt})">Trade</button></td>
</tr>`).join("");
}

function openTrade(s,e,sl,t){
 let html=`<html><body style="background:#020617;color:white;padding:20px;font-family:sans-serif">
<h2>${s}</h2>
Entry ${e.toFixed(2)} SL ${sl.toFixed(2)} Target ${t.toFixed(2)}<br><br>
Qty <input id=q oninput="b.value=(q.value*${e}/5).toFixed(2)">
Budget <input id=b oninput="q.value=Math.floor(b.value*5/${e})">
</body></html>`;
 let w=window.open();w.document.write(html);w.document.close();
}

function addStock(){
 let s=newStock.value.trim().toUpperCase();
 if(s&&!STOCKS.includes(s)){STOCKS.push(s);loadStock(s);}
 newStock.value="";
}

function takeScreenshot(){
 html2canvas(document.body).then(c=>{
  let d=new Date();
  let name=d.toLocaleTimeString().replace(/:/g,'')+"_"+d.toLocaleDateString().replace(/\//g,'')+"_STOCKS.png";
  let a=document.createElement("a");
  a.href=c.toDataURL(); a.download=name; a.click();
 });
}

async function init(){
 for(let s of STOCKS) await loadStock(s);
 render();
 setInterval(async()=>{for(let s of STOCKS)await loadStock(s);render();},60000);
}
init();
</script>
</body>
</html>
