<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Professional Trading Dashboard</title>
<style>
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(circle at top,#0b1d3a,#000814);
  color:white;
}
.container{padding:20px}
h1{font-size:28px}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
.card{
  background:#081a35;
  padding:20px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 0 20px #000;
}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
input,select,button{
  background:#0b254a;color:white;border:1px solid #123;
  padding:10px 14px;border-radius:10px;
}
table{width:100%;border-collapse:collapse;font-size:14px}
th{
  position:sticky;top:0;
  background:#081a35;padding:10px;text-align:left
}
td{padding:10px;border-bottom:1px solid #0a1c33}
.buy{color:#00ff9c;font-weight:bold}
.sell{color:#ff5252;font-weight:bold}
.hold{color:#fff}
.up{color:#00ff9c}
.down{color:#ff5252}
.side{color:orange}
.trade-btn{
  background:#0b254a;border:1px solid #123;
  padding:6px 10px;border-radius:8px;cursor:pointer
}
.small{font-size:11px;color:#aaa}
</style>
</head>
<body>
<div class="container">
<h1>ðŸ“Š Professional Trading Dashboard</h1>

<div class="cards">
  <div class="card">Gold<br><span id="gold">â‚¹--</span></div>
  <div class="card">Silver<br><span id="silver">â‚¹--</span></div>
  <div class="card">Copper<br><span id="copper">â‚¹--</span></div>
  <div class="card">USDINR<br><span id="usd">â‚¹--</span></div>
</div>

<div class="controls">
  <input placeholder="Search stock..." id="search">
  <button onclick="filterSignal('BUY')">Only Buy</button>
  <button onclick="filterSignal('SELL')">Only Sell</button>
  <button onclick="filterSignal('ALL')">All</button>
  <select id="sort" onchange="render()">
    <option value="">Sort</option>
    <option value="price_desc">Price â†“</option>
    <option value="price_asc">Price â†‘</option>
    <option value="rsi_desc">RSI â†“</option>
    <option value="rsi_asc">RSI â†‘</option>
    <option value="vol_desc">Volume â†“</option>
    <option value="vol_asc">Volume â†‘</option>
  </select>
  <button onclick="screenshot()">ðŸ“¸ Screenshot</button>
</div>

<div id="time">Last refresh: --</div>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th><th>Trend</th>
<th>Signal</th><th>Trade</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>
</div>

<script>
const worker="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks=["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","JPPOWER","HDFCBANK","SBIN","MON100","RVNL","RBLBANK","TCS","KIMS"];
let data={},filter="ALL";

function ema(arr,n){
  let k=2/(n+1),e=arr[0];
  for(let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k);
  return e;
}
function rsi(arr){
  let g=0,l=0;
  for(let i=1;i<arr.length;i++){
    let d=arr[i]-arr[i-1];
    if(d>0)g+=d; else l-=d;
  }
  let rs=g/(l||1);
  return 100-(100/(1+rs));
}

async function load(sym){
  try{
    let r=await fetch(worker+"/candles?symbol="+sym);
    let j=await r.json();
    let c=Array.isArray(j)?j:j.candles;
    if(!c||c.length<30) return;

    let closes=c.map(x=>+x.close);
    let highs=c.map(x=>+x.high);
    let lows=c.map(x=>+x.low);
    let vols=c.map(x=>+x.volume||0);

    let live=closes.at(-1);
    let e9=ema(closes.slice(-30),9);
    let e21=ema(closes.slice(-30),21);
    let R=rsi(closes.slice(-15));

    let sup=Math.min(...lows.slice(-10));
    let res=Math.max(...highs.slice(-10));

    let trend=e9>e21?"Uptrend":e9<e21?"Downtrend":"Sideways";
    let signal=e9>e21&&R>55?"BUY":e9<e21&&R<45?"SELL":"HOLD";

    let sl=signal==="BUY"?sup:res;
    let tgt=signal==="BUY"?live+(live-sup):live-(res-live);

    data[sym]={sym,live,today:`L:${lows.at(-1).toFixed(1)} H:${highs.at(-1).toFixed(1)}`,
      week:`L:${Math.min(...lows.slice(-5)).toFixed(1)} H:${Math.max(...highs.slice(-5)).toFixed(1)}`,
      month:`L:${Math.min(...lows.slice(-22)).toFixed(1)} H:${Math.max(...highs.slice(-22)).toFixed(1)}`,
      vol:(vols.at(-1)/100000).toFixed(0),
      rsi:R.toFixed(1),ema9:e9.toFixed(2),ema21:e21.toFixed(2),
      sup:sup.toFixed(2),res:res.toFixed(2),trend,signal,
      sl:sl.toFixed(2),tgt:tgt.toFixed(2)};
  }catch(e){console.log(sym,e)}
}

function render(){
  let arr=Object.values(data).filter(x=>filter==="ALL"||x.signal===filter);
  let s=document.getElementById("search").value.toUpperCase();
  arr=arr.filter(x=>x.sym.includes(s));

  let sort=document.getElementById("sort").value;
  if(sort==="price_desc")arr.sort((a,b)=>b.live-a.live);
  if(sort==="price_asc")arr.sort((a,b)=>a.live-b.live);
  if(sort==="rsi_desc")arr.sort((a,b)=>b.rsi-a.rsi);
  if(sort==="rsi_asc")arr.sort((a,b)=>a.rsi-b.rsi);
  if(sort==="vol_desc")arr.sort((a,b)=>b.vol-a.vol);
  if(sort==="vol_asc")arr.sort((a,b)=>a.vol-b.vol);

  rows.innerHTML=arr.map(x=>`
<tr>
<td class="${x.signal==='BUY'?'buy':x.signal==='SELL'?'sell':'hold'}"><b>${x.sym}</b></td>
<td>${x.live}</td>
<td class="small">${x.today}</td>
<td class="small">${x.week}</td>
<td>${x.vol}</td>
<td class="small">${x.month}</td>
<td>${x.rsi}</td>
<td>${x.ema9}</td>
<td>${x.ema21}</td>
<td>${x.sup}</td>
<td>${x.res}</td>
<td class="${x.trend==='Uptrend'?'up':x.trend==='Downtrend'?'down':'side'}">${x.trend}</td>
<td class="${x.signal==='BUY'?'buy':x.signal==='SELL'?'sell':'hold'}">${x.signal}</td>
<td><button class="trade-btn" onclick="trade('${x.sym}',${x.live},${x.sl},${x.tgt})">Trade</button></td>
<td>${x.sl}</td>
<td>${x.tgt}</td>
</tr>`).join("");
}

function filterSignal(f){filter=f;render()}
function trade(s,e,sl,t){window.open(`trade.html?stock=${s}&entry=${e}&sl=${sl}&target=${t}`)}
function screenshot(){html2canvas(document.body).then(c=>{let a=document.createElement("a");a.download="dashboard.png";a.href=c.toDataURL();a.click();});}

async function loadMCX(){
  try{
    let g=await fetch(worker+"/mcx?symbol=GOLD").then(r=>r.json());
    let s=await fetch(worker+"/mcx?symbol=SILVER").then(r=>r.json());
    document.getElementById("gold").innerText="â‚¹"+(g.price||g.last||"--");
    document.getElementById("silver").innerText="â‚¹"+(s.price||s.last||"--");
  }catch{}
}

async function refresh(){
  for(let s of stocks) await load(s);
  render();
  document.getElementById("time").innerText="Last refresh: "+new Date().toLocaleTimeString();
}

refresh();loadMCX();setInterval(refresh,60000);
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
