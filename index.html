<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Professional Trading Dashboard</title>
<style>
body {
  background: radial-gradient(circle at top, #0c1a33, #020814);
  font-family: Inter, system-ui;
  color: white;
  margin: 0;
}
header { padding: 20px; font-size: 26px; font-weight: bold; }
.container { padding: 10px 20px; }

.cards { display:grid; grid-template-columns: repeat(4,1fr); gap:15px; }
.card {
  background:#081a36;
  border-radius:16px;
  padding:20px;
  text-align:center;
  box-shadow: inset 0 0 20px rgba(0,0,0,.6);
}

.controls { display:flex; gap:8px; margin:15px 0; flex-wrap:wrap;}
input,button,select {
  background:#081f40;
  color:white;
  border:1px solid #1c3b6c;
  padding:8px 12px;
  border-radius:10px;
}

table { width:100%; border-collapse:collapse; font-size:14px; }
thead { position:sticky; top:0; background:#071831; }
th,td { padding:8px; border-bottom:1px solid #0f2a52; text-align:center;}
.stock-buy {color:#00ff9c;font-weight:bold;}
.stock-sell{color:#ff4d4d;font-weight:bold;}
.stock-hold{color:white;font-weight:bold;}

.trend-up{color:#00ff9c}
.trend-down{color:#ff4d4d}
.trend-side{color:orange}

button.trade {background:#0d3c78;border-radius:20px}
.popup {
 position:fixed; bottom:20px; right:20px;
 background:#081f40; padding:12px;
 border-radius:12px; margin-top:8px;
 box-shadow:0 0 20px black;
}
</style>
</head>
<body>
<header>ðŸ“Š Professional Trading Dashboard</header>
<div class="container">

<div class="cards">
  <div class="card"><h3>Gold</h3><div id="gold">â‚¹--</div></div>
  <div class="card"><h3>Silver</h3><div id="silver">â‚¹--</div></div>
  <div class="card"><h3>Copper</h3><div id="copper">â‚¹--</div></div>
  <div class="card"><h3>USDINR</h3><div id="usd">â‚¹--</div></div>
</div>

<div class="controls">
  <input id="search" placeholder="Search stock">
  <button onclick="filterSignal='BUY';render()">Only Buy</button>
  <button onclick="filterSignal='SELL';render()">Only Sell</button>
  <button onclick="filterSignal='ALL';render()">All</button>

  <select onchange="sortBy=this.value;render()">
    <option value="">Sort</option>
    <option value="price_desc">Price â†“</option>
    <option value="price_asc">Price â†‘</option>
    <option value="rsi_desc">RSI â†“</option>
    <option value="rsi_asc">RSI â†‘</option>
    <option value="vol_desc">Volume â†“</option>
    <option value="vol_asc">Volume â†‘</option>
  </select>
</div>

<div id="time"></div>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th>
<th>Trend</th><th>Signal</th>
<th>Trade</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<div id="alerts"></div>

</div>

<script>
const worker="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks=["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","JPPOWER","HDFCBANK","SBIN","MON100","RVNL","RBLBANK","TCS","KIMS"];
let data={},filterSignal="ALL",sortBy="";

async function loadStock(sym){
 let r=await fetch(`${worker}/candles?symbol=${sym}`);
 let j=await r.json();
 let candles=j.candles;
 if(!candles||candles.length<30) return;

 let closes=candles.map(c=>c.close);
 let highs=candles.map(c=>c.high);
 let lows=candles.map(c=>c.low);
 let vols=candles.map(c=>c.volume);

 let live=closes.at(-1);
 let rsi=calcRSI(closes);
 let ema9=ema(closes,9);
 let ema21=ema(closes,21);

 let support=Math.min(...lows.slice(-10));
 let resistance=Math.max(...highs.slice(-10));

 let trend=ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
 let signal=(ema9>ema21 && rsi>55)?"BUY":(ema9<ema21 && rsi<45)?"SELL":"HOLD";

 let entry=live;
 let sl=signal==="BUY"?support:resistance;
 let target=signal==="BUY"?live+(live-sl):live-(sl-live);

 data[sym]={sym,live,rsi,ema9,ema21,support,resistance,trend,signal,entry,sl,target,
 today:`L:${lows.at(-1).toFixed(1)} H:${highs.at(-1).toFixed(1)}`,
 week:`L:${Math.min(...lows.slice(-5)).toFixed(1)} H:${Math.max(...highs.slice(-5)).toFixed(1)}`,
 month:`L:${Math.min(...lows.slice(-22)).toFixed(1)} H:${Math.max(...highs.slice(-22)).toFixed(1)}`,
 vol:(vols.at(-1)/100000).toFixed(0)
 };
}

function render(){
 let rows=Object.values(data)
 .filter(s=>filterSignal==="ALL"||s.signal===filterSignal)
 .filter(s=>s.sym.includes(document.getElementById("search").value.toUpperCase()));

 if(sortBy){
  rows.sort((a,b)=>{
   if(sortBy==="price_desc")return b.live-a.live;
   if(sortBy==="price_asc")return a.live-b.live;
   if(sortBy==="rsi_desc")return b.rsi-a.rsi;
   if(sortBy==="rsi_asc")return a.rsi-b.rsi;
   if(sortBy==="vol_desc")return b.vol-a.vol;
   if(sortBy==="vol_asc")return a.vol-b.vol;
  });
 }

 body.innerHTML=rows.map(s=>`
<tr>
<td class="stock-${s.signal.toLowerCase()}">${s.sym}</td>
<td>${s.live.toFixed(2)}</td>
<td>${s.today}</td>
<td>${s.week}</td>
<td>${s.vol}</td>
<td>${s.month}</td>
<td>${s.rsi.toFixed(1)}</td>
<td>${s.ema9.toFixed(2)}</td>
<td>${s.ema21.toFixed(2)}</td>
<td>${s.support.toFixed(2)}</td>
<td>${s.resistance.toFixed(2)}</td>
<td class="trend-${s.trend.startsWith('Up')?'up':s.trend.startsWith('Down')?'down':'side'}">${s.trend}</td>
<td>${s.signal}</td>
<td><button class="trade" onclick="trade('${s.sym}')">Trade</button></td>
<td>${s.sl.toFixed(2)}</td>
<td>${s.target.toFixed(2)}</td>
</tr>`).join("");
}

function trade(sym){
 let s=data[sym];
 location.href=`trade.html?stock=${sym}&entry=${s.entry}&sl=${s.sl}&target=${s.target}`;
}

function ema(arr,n){let k=2/(n+1),e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;}
function calcRSI(arr){
 let g=0,l=0;
 for(let i=arr.length-15;i<arr.length-1;i++){
  let d=arr[i+1]-arr[i];
  if(d>0)g+=d; else l-=d;
 }
 let rs=g/l; return 100-(100/(1+rs));
}

async function refresh(){
 for(let s of stocks) await loadStock(s);
 render();
 time.innerText="Last refresh: "+new Date().toLocaleTimeString();
}
refresh();
setInterval(refresh,60000);
</script>
</body>
</html>
