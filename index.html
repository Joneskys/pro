<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Professional Trading Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  background: radial-gradient(circle at top, #0f1c3f, #020617);
  color: #e6eefc;
}
header { padding:20px; font-size:28px; font-weight:700; }
.cards {
  display:grid; grid-template-columns: repeat(4,1fr); gap:16px; padding:20px;
}
.card {
  background: linear-gradient(145deg,#0c1b3d,#071226);
  padding:24px; border-radius:20px; text-align:center;
  box-shadow: 0 10px 40px #000;
}
.toolbar {
  display:flex; flex-wrap:wrap; gap:10px; padding:0 20px 10px;
}
input, select, button {
  background:#0b1b38; color:white; border:1px solid #1f355e;
  border-radius:10px; padding:10px 14px;
}
button { cursor:pointer; font-weight:600; }
table {
  width:100%; border-collapse:collapse; font-size:14px;
}
thead th {
  position:sticky; top:0;
  background:#08162f; padding:10px;
}
tbody td {
  padding:10px; border-bottom:1px solid #13274b;
}
tr:hover { background:#0b1f3f; }
.buy { color:#00ff99; font-weight:700;}
.sell { color:#ff4d4d; font-weight:700;}
.hold { color:#ffaa00; font-weight:700;}
.up { color:#00ff99; }
.down { color:#ff4d4d; }
.side { color:#ffaa00; }
.small { font-size:11px; opacity:0.7; }
.trade-btn {
  background:#0d2a5c; border-radius:12px; padding:6px 14px;
}
.alerts { position:fixed; top:20px; right:20px; display:flex; flex-direction:column; gap:10px;}
.alert {
  padding:12px 16px; border-radius:12px; background:#0b1b38;
  box-shadow:0 10px 30px #000; min-width:240px;
}
</style>
</head>

<body>
<header>ðŸ“Š Professional Trading Dashboard</header>

<div class="cards">
  <div class="card"><h3>Gold</h3><div id="gold">â‚¹--</div></div>
  <div class="card"><h3>Silver</h3><div id="silver">â‚¹--</div></div>
  <div class="card"><h3>Copper</h3><div id="copper">â‚¹--</div></div>
  <div class="card"><h3>USDINR</h3><div id="usd">â‚¹--</div></div>
</div>

<div class="toolbar">
  <input type="date" id="date"/>
  <button onclick="refreshAll()">Submit</button>
  <input placeholder="Search" oninput="search=this.value;render()"/>
  <button onclick="filter='BUY';render()">Only Buy</button>
  <button onclick="filter='SELL';render()">Only Sell</button>
  <button onclick="filter='ALL';render()">All</button>
  <select onchange="sort=this.value;render()">
    <option value="">Sort</option>
    <option value="price_desc">Price High â†’ Low</option>
    <option value="price_asc">Price Low â†’ High</option>
    <option value="rsi_desc">RSI High â†’ Low</option>
    <option value="rsi_asc">RSI Low â†’ High</option>
    <option value="vol_desc">Volume High â†’ Low</option>
    <option value="vol_asc">Volume Low â†’ High</option>
  </select>
  <span id="time"></span>
</div>

<div style="padding:20px">
  <table>
    <thead>
      <tr>
        <th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th>
        <th>1M</th><th>RSI</th><th>EMA9</th><th>EMA21</th>
        <th>Support</th><th>Resistance</th>
        <th>Trend</th><th>Signal</th>
        <th>Trade</th><th>SL</th><th>Target</th><th></th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>
</div>

<div class="alerts" id="alerts"></div>

<script>
const worker = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks = ["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let data = {};
let filter="ALL", sort="", search="";

async function loadStock(sym){
  const res = await fetch(`${worker}/candles?symbol=${sym}`);
  const j = await res.json();

  const candles = j.candles || j.data || j; // adjust if needed

  const closes = candles.map(c=>c.c);
  const highs = candles.map(c=>c.h);
  const lows  = candles.map(c=>c.l);
  const vols  = candles.map(c=>c.v);

  const live = closes.at(-1);
  const prev = closes.at(-2);
  const change = ((live-prev)/prev*100).toFixed(2);

  const today = `L:${lows.at(-1)} H:${highs.at(-1)} ${change}%`;
  const w = candles.slice(-5);
  const m = candles.slice(-22);

  const calcRange = arr => `L:${Math.min(...arr.map(x=>x.l))} H:${Math.max(...arr.map(x=>x.h))}`;

  const rsi = calcRSI(closes);
  const ema9 = EMA(closes,9);
  const ema21 = EMA(closes,21);
  const sup = Math.min(...lows.slice(-20));
  const resi = Math.max(...highs.slice(-20));

  let trend = ema9 > ema21 ? "Uptrend" : ema9 < ema21 ? "Downtrend":"Sideways";
  let signal = rsi>60 && ema9>ema21 ? "BUY" : rsi<40 && ema9<ema21 ? "SELL":"HOLD";

  let sl = signal=="BUY" ? live*0.985 : live*1.015;
  let tgt = signal=="BUY" ? live*1.02 : live*0.98;

  data[sym] = {
    sym, live, today,
    w:calcRange(w), m:calcRange(m),
    vol:(vols.at(-1)/100000).toFixed(0),
    rsi:rsi.toFixed(1),
    ema9:ema9.toFixed(2),
    ema21:ema21.toFixed(2),
    sup:sup.toFixed(2),
    res:resi.toFixed(2),
    trend, signal,
    sl:sl.toFixed(2),
    tgt:tgt.toFixed(2)
  };
}

function render(){
  let arr = Object.values(data);
  if(filter!=="ALL") arr = arr.filter(x=>x.signal===filter);
  if(search) arr = arr.filter(x=>x.sym.includes(search.toUpperCase()));
  if(sort==="price_desc") arr.sort((a,b)=>b.live-a.live);
  if(sort==="price_asc") arr.sort((a,b)=>a.live-b.live);
  if(sort==="rsi_desc") arr.sort((a,b)=>b.rsi-a.rsi);
  if(sort==="rsi_asc") arr.sort((a,b)=>a.rsi-b.rsi);
  if(sort==="vol_desc") arr.sort((a,b)=>b.vol-a.vol);
  if(sort==="vol_asc") arr.sort((a,b)=>a.vol-b.vol);

  document.getElementById("body").innerHTML = arr.map(s=>`
    <tr>
      <td class="${s.signal=="BUY"?"buy":s.signal=="SELL"?"sell":"hold"}"><b>${s.sym}</b></td>
      <td>${s.live}</td>
      <td class="small">${s.today}</td>
      <td class="small">${s.w}</td>
      <td>${s.vol}</td>
      <td class="small">${s.m}</td>
      <td>${s.rsi}</td>
      <td>${s.ema9}</td>
      <td>${s.ema21}</td>
      <td>${s.sup}</td>
      <td>${s.res}</td>
      <td class="${s.trend=="Uptrend"?"up":s.trend=="Downtrend"?"down":"side"}">${s.trend}</td>
      <td class="${s.signal=="BUY"?"buy":s.signal=="SELL"?"sell":"hold"}">${s.signal}</td>
      <td>${s.live}</td>
      <td>${s.sl}</td>
      <td>${s.tgt}</td>
      <td><button class="trade-btn" onclick="openTrade('${s.sym}',${s.live},${s.sl},${s.tgt})">Trade</button></td>
    </tr>`).join("");
}

function openTrade(sym,e,sl,t){
  const html = `
  <h2>${sym}</h2>
  Entry <input id=e value="${e}"><br>
  SL <input id=s value="${sl}"><br>
  Target <input id=t value="${t}"><br>
  Qty <input id=q value="100"><br>
  Budget <input id=b><br>
  <button onclick="calc()">Calc</button>
  <div id=r></div>
  <script>
    function round(x){return (Math.round(x*20)/20).toFixed(2);}
    function calc(){
      const e=+E.value,s=+S.value,t=+T.value,q=+Q.value;
      let pnlSL = (s-e)*q;
      let pnlT = (t-e)*q;
      R.innerHTML = "<p style=color:red>SL P/L: â‚¹"+round(pnlSL)+"</p><p style=color:lime>Target P/L: â‚¹"+round(pnlT)+"</p>";
    }
  </script>`;
  const w = open(); w.document.write(html);
}

function EMA(arr,n){
  let k=2/(n+1), ema=arr[0];
  for(let i=1;i<arr.length;i++) ema=arr[i]*k+ema*(1-k);
  return ema;
}
function calcRSI(cl){
  let g=0,l=0;
  for(let i=cl.length-14;i<cl.length;i++){
    let d=cl[i]-cl[i-1];
    if(d>0) g+=d; else l-=d;
  }
  let rs=g/(l||1);
  return 100-(100/(1+rs));
}

async function refreshAll(){
  for(const s of stocks) await loadStock(s);
  render();
  document.getElementById("time").innerText = new Date().toLocaleTimeString();
}
refreshAll();
setInterval(refreshAll,60000);
</script>
</body>
</html>
