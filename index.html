<script>
const WORKER = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const CANDLE_API = s => `${WORKER}/candles?symbol=${s}`;
const MCX_API = `${WORKER}/mcx`;

let STOCKS = ["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let DB = {}, filter="all", muted=false, lastSignals={};

async function loadStock(symbol){
  try {
    const res = await fetch(CANDLE_API(symbol));
    const json = await res.json();

    // Expected format: [{t,o,h,l,c,v}, ...]
    DB[symbol] = json.map(x => ({
      date: new Date(x.t * 1000).toISOString().slice(0,10),
      open: +x.o,
      high: +x.h,
      low: +x.l,
      close: +x.c,
      volume: +x.v
    })).filter(x => x.close);
  } catch(e) {
    console.warn(symbol, "fallback mock");
    DB[symbol] = mock();
  }
}

// --------- INDICATORS ----------
function EMA(values, period) {
  let k = 2 / (period + 1);
  let ema = values[0];
  for (let i = 1; i < values.length; i++)
    ema = values[i] * k + ema * (1 - k);
  return ema;
}

function RSI(values, period = 14) {
  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    let diff = values[i] - values[i - 1];
    diff >= 0 ? gains += diff : losses -= diff;
  }
  let rs = gains / (losses || 1);
  return 100 - (100 / (1 + rs));
}

// --------- STRUCTURE BASED S/R ----------
function swingLevels(candles) {
  let lows = candles.slice(-30).map(x => x.low);
  let highs = candles.slice(-30).map(x => x.high);
  return {
    support: Math.min(...lows),
    resistance: Math.max(...highs)
  };
}

// --------- SIGNAL ENGINE ----------
function generateSignal(price, ema9, ema21, rsi, support, resistance) {
  if (price > ema9 && ema9 > ema21 && rsi > 55 && price > resistance * 0.995)
    return "BUY";
  if (price < ema9 && ema9 < ema21 && rsi < 45 && price < support * 1.005)
    return "SELL";
  return "HOLD";
}

function calcTrade(sig, price, support, resistance) {
  if (sig === "BUY") {
    let sl = support;
    let target = price + (price - sl) * 2;
    return { entry: price, sl, target };
  }
  if (sig === "SELL") {
    let sl = resistance;
    let target = price - (sl - price) * 2;
    return { entry: price, sl, target };
  }
  return { entry: price, sl: null, target: null };
}

// --------- ALERT ----------
function alertSignal(sym, sig){
  if(sig==="HOLD" || lastSignals[sym] === sig) return;
  lastSignals[sym] = sig;
  popupText.innerHTML = `<b class="${sig==='BUY'?'green':'red'}">${sym} ${sig}</b>`;
  popup.style.display = "block";

  if(!muted){
    let a = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
    a.loop = true; a.play();
    setTimeout(()=>{a.pause();a.currentTime=0},3000);
  }
}

// --------- RENDER ----------
function render() {
  time.textContent = new Date().toLocaleTimeString();
  let q = search.value.toLowerCase();
  let rows = [];

  for (let s of STOCKS) {
    let d = DB[s];
    if (!d || d.length < 30) continue;
    if (q && !s.toLowerCase().includes(q)) continue;

    let t = d.at(-1);
    let closes = d.map(x=>x.close);
    let ema9 = EMA(closes.slice(-50), 9);
    let ema21 = EMA(closes.slice(-50), 21);
    let rsi = RSI(closes.slice(-15));

    let {support, resistance} = swingLevels(d);
    let sig = generateSignal(t.close, ema9, ema21, rsi, support, resistance);
    let trade = calcTrade(sig, t.close, support, resistance);

    if(filter==='buy' && sig!=='BUY') continue;
    if(filter==='sell' && sig!=='SELL') continue;

    let volL = Math.round(t.volume / 100000);

    rows.push({s,t,rsi,ema9,ema21,support,resistance,sig,trade,volL});
  }

  let html = "";
  for(let r of rows){
    alertSignal(r.s,r.sig);
    html += `
    <tr>
      <td class="bold ${r.sig==='BUY'?'green':r.sig==='SELL'?'red':''}">${r.s}</td>
      <td>${r.t.close.toFixed(2)}</td>
      <td class="small">L:${r.t.low.toFixed(1)} H:${r.t.high.toFixed(1)} V:${r.volL}L</td>
      <td>-</td><td>-</td>
      <td>${r.rsi.toFixed(1)}</td>
      <td>${r.ema9.toFixed(2)}</td>
      <td>${r.ema21.toFixed(2)}</td>
      <td>${r.support.toFixed(2)}</td>
      <td>${r.resistance.toFixed(2)}</td>
      <td>${r.ema9 > r.ema21 ? 'Uptrend' : 'Downtrend'}</td>
      <td class="${r.sig==='BUY'?'green':r.sig==='SELL'?'red':'orange'}">${r.sig}</td>
      <td>${r.trade.entry.toFixed(2)}</td>
      <td>${r.trade.sl ? r.trade.sl.toFixed(2) : '-'}</td>
      <td>${r.trade.target ? r.trade.target.toFixed(2) : '-'}</td>
      <td><button onclick="openTrade('${r.s}',${r.trade.entry},${r.trade.sl||0},${r.trade.target||0})">Trade</button></td>
    </tr>`;
  }
  tbody.innerHTML = html;
}

// -------- INIT ----------
async function init(){
  for(let s of STOCKS) await loadStock(s);
  render();
  setInterval(()=>render(), 60000);
}
init();
</script>
