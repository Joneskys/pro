<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Professional Trading Dashboard</title>
<style>
body {
  background: radial-gradient(circle at top, #0b1e3d, #020617);
  font-family: Arial, sans-serif;
  color: white;
}
h1 { margin: 20px; }
.top { display: flex; gap: 10px; margin: 10px 20px; flex-wrap: wrap; }
button, select, input {
  background: #0f2a52;
  color: white;
  border: 1px solid #1e3a8a;
  padding: 8px 12px;
  border-radius: 10px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
thead { position: sticky; top: 0; background: #0b2a55; }
th, td { padding: 8px; text-align: center; border-bottom: 1px solid #102d5a; }
.buy { color: #00ff88; font-weight: bold; }
.sell { color: #ff4d4d; font-weight: bold; }
.hold { color: #ccc; font-weight: bold; }
.up { color: #00ff88; }
.down { color: #ff4d4d; }
.side { color: orange; }
.small { font-size: 11px; opacity: 0.8; }
.tradebtn { background: #1e40af; cursor: pointer; }
</style>
</head>
<body>

<h1>ðŸ“Š Professional Trading Dashboard</h1>

<div class="top">
  <input id="search" placeholder="Search stock">
  <button onclick="filterSignal('BUY')">Only Buy</button>
  <button onclick="filterSignal('SELL')">Only Sell</button>
  <button onclick="filterSignal('ALL')">All</button>
  <select id="sort" onchange="render()">
    <option value="">Sort</option>
    <option value="priceDesc">Price â†“</option>
    <option value="priceAsc">Price â†‘</option>
    <option value="rsiDesc">RSI â†“</option>
    <option value="rsiAsc">RSI â†‘</option>
    <option value="volDesc">Volume â†“</option>
    <option value="volAsc">Volume â†‘</option>
  </select>
  <button onclick="screenshot()">ðŸ“¸ Screenshot</button>
</div>

<p style="margin:10px 20px">Last refresh: <span id="time"></span></p>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th><th>Trend</th><th>Signal</th>
<th>Trade</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
const worker = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks = ["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let store = {};
let filter = "ALL";

function EMA(arr,n){let k=2/(n+1),e=arr[0];for(let i=1;i<arr.length;i++)e=arr[i]*k+e*(1-k);return e;}
function RSI(arr){let g=0,l=0;for(let i=1;i<arr.length;i++){let d=arr[i]-arr[i-1];if(d>0)g+=d;else l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

async function loadStock(sym){
 try{
  const r=await fetch(worker+"/candles?symbol="+sym);
  const j=await r.json();
  const c=j.candles||j.data||[];
  if(!c.length) return;

  const cl=c.map(x=>+x.close||+x.c||0);
  const hi=c.map(x=>+x.high||+x.h||0);
  const lo=c.map(x=>+x.low||+x.l||0);
  const vo=c.map(x=>+x.volume||+x.v||0);

  const live=cl.at(-1);
  const ema9=EMA(cl.slice(-30),9);
  const ema21=EMA(cl.slice(-30),21);
  const rsi=RSI(cl.slice(-15));
  const sup=Math.min(...lo.slice(-10));
  const res=Math.max(...hi.slice(-10));

  const trend=ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
  const signal=(ema9>ema21 && rsi>55)?"BUY":(ema9<ema21 && rsi<45)?"SELL":"HOLD";

  store[sym]={
    sym,
    live, today:`L:${lo.at(-1).toFixed(1)} H:${hi.at(-1).toFixed(1)}`,
    week:`L:${Math.min(...lo.slice(-5)).toFixed(1)} H:${Math.max(...hi.slice(-5)).toFixed(1)}`,
    month:`L:${Math.min(...lo.slice(-22)).toFixed(1)} H:${Math.max(...hi.slice(-22)).toFixed(1)}`,
    vol:(vo.at(-1)/100000).toFixed(0),
    rsi:rsi.toFixed(1), ema9:ema9.toFixed(2), ema21:ema21.toFixed(2),
    sup:sup.toFixed(2), res:res.toFixed(2),
    trend, signal,
    sl:(signal==="BUY"?sup:res).toFixed(2),
    target:(signal==="BUY"?live+(live-sup):live-(res-live)).toFixed(2)
  };
 }catch(e){console.log(sym,"fail");}
}

function render(){
 let arr=Object.values(store);
 const q=document.getElementById("search").value.toUpperCase();
 arr=arr.filter(x=>x.sym.includes(q));
 if(filter!=="ALL") arr=arr.filter(x=>x.signal===filter);

 const s=document.getElementById("sort").value;
 if(s==="priceDesc") arr.sort((a,b)=>b.live-a.live);
 if(s==="priceAsc") arr.sort((a,b)=>a.live-b.live);
 if(s==="rsiDesc") arr.sort((a,b)=>b.rsi-a.rsi);
 if(s==="rsiAsc") arr.sort((a,b)=>a.rsi-b.rsi);
 if(s==="volDesc") arr.sort((a,b)=>b.vol-a.vol);
 if(s==="volAsc") arr.sort((a,b)=>a.vol-b.vol);

 const tb=document.getElementById("rows");
 tb.innerHTML=arr.map(s=>`
<tr>
<td class="${s.signal==='BUY'?'buy':s.signal==='SELL'?'sell':'hold'}">${s.sym}</td>
<td>${s.live.toFixed(2)}</td>
<td class="small">${s.today}</td>
<td class="small">${s.week}</td>
<td>${s.vol}</td>
<td class="small">${s.month}</td>
<td>${s.rsi}</td><td>${s.ema9}</td><td>${s.ema21}</td>
<td>${s.sup}</td><td>${s.res}</td>
<td class="${s.trend==='Uptrend'?'up':s.trend==='Downtrend'?'down':'side'}">${s.trend}</td>
<td class="${s.signal==='BUY'?'buy':s.signal==='SELL'?'sell':'hold'}">${s.signal}</td>
<td><button class="tradebtn" onclick="trade('${s.sym}',${s.live},${s.sl},${s.target})">Trade</button></td>
<td>${s.sl}</td><td>${s.target}</td>
</tr>`).join("");
}

function trade(sym,l,sl,tg){
  window.open(`trade.html?symbol=${sym}&buy=${l}&sl=${sl}&target=${tg}`);
}
function filterSignal(x){filter=x;render();}
function screenshot(){
 const name=new Date().toLocaleString().replace(/[^\w]/g,"_")+"_STOCKS.png";
 html2canvas(document.body).then(c=>{
   let a=document.createElement("a");
   a.download=name; a.href=c.toDataURL(); a.click();
 });
}

async function refresh(){
 store={};
 for(const s of stocks) await loadStock(s);
 render();
 document.getElementById("time").innerText=new Date().toLocaleTimeString();
}
refresh();
setInterval(refresh,60000);
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
