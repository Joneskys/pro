<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Professional Trading Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
body { background:#0b1220;color:#e5e7eb;font-family:system-ui;margin:0 }
header, .panel { background:#020617;padding:10px;position:sticky;top:0;z-index:9 }
input,select,button { background:#0f172a;color:white;border:1px solid #1f2937;padding:6px 10px;border-radius:8px }
button{cursor:pointer}
table { width:100%; border-collapse:collapse; font-size:12px }
th,td { padding:6px;border:1px solid #1f2937;text-align:center }
th { background:#020617;position:sticky;top:40px }
.green{color:#22c55e;font-weight:bold}
.red{color:#ef4444;font-weight:bold}
.orange{color:#f59e0b;font-weight:bold}
.bold{font-weight:800}
.small{font-size:11px;color:#94a3b8}
.popup{position:fixed;bottom:20px;right:20px;background:#020617;padding:10px;border-radius:10px;display:none}
.tradeBtn{background:#1e40af}
.topcards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:10px}
.card{background:#020617;padding:10px;border-radius:12px;text-align:center}
</style>
</head>
<body>

<div class="topcards">
  <div class="card">Gold<div id="gold">â‚¹--</div></div>
  <div class="card">Silver<div id="silver">â‚¹--</div></div>
  <div class="card">Copper<div id="copper">â‚¹--</div></div>
  <div class="card">USDINR<div id="usd">â‚¹--</div></div>
</div>

<header>
  <input type="date" id="date" />
  <button onclick="render()">Submit</button>
  <input id="search" placeholder="Search..." oninput="render()" />
  <button onclick="filter='buy';render()">Only Buy</button>
  <button onclick="filter='sell';render()">Only Sell</button>
  <button onclick="filter='all';render()">All</button>
  <select id="sort" onchange="render()">
    <option value="">Sort</option>
    <option value="priceDesc">Price â†“</option>
    <option value="volDesc">Volume â†“</option>
    <option value="rsiDesc">RSI â†“</option>
  </select>
  <input id="newStock" placeholder="Add stock (INFY)">
  <button onclick="addStock()">Add</button>
  <button onclick="takeScreenshot()">ðŸ“¸ Screenshot</button>
  <span class="small">Last refresh: <span id="time"></span></span>
</header>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th><th>Support</th><th>Resistance</th>
<th>Trend</th><th>Signal</th><th>Trade</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div class="popup" id="popup">
  <span id="popupText"></span>
  <button onclick="popup.style.display='none'">X</button>
</div>

<script>
const WORKER = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const STOCK_API = s => `${WORKER}?symbol=${s}`;
const MCX_API = `${WORKER}/mcx`;

let STOCKS = ["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let DB={}, filter="all", lastSignals={};

function EMA(arr,p){let k=2/(p+1),e=arr[0];for(let v of arr)e=v*k+e*(1-k);return e;}
function RSI(arr){let g=0,l=0;for(let i=1;i<=14;i++){let d=arr[i]-arr[i-1];d>0?g+=d:l-=d;}let rs=g/(l||1);return 100-(100/(1+rs));}

async function loadStock(s){
  try{
    let json = await (await fetch(STOCK_API(s))).json();
    DB[s] = json.map(x=>({
      t:new Date(x.t*1000),
      open:+x.o,high:+x.h,low:+x.l,close:+x.c,volume:+x.v
    })).filter(x=>x.close);
  }catch{console.warn(s,"fallback")}
}

async function loadMCX(){
  try{
    let d = await (await fetch(MCX_API)).json();
    gold.textContent = d.gold_10g?`â‚¹${d.gold_10g}`:"â‚¹--";
    silver.textContent = d.silver_1kg?`â‚¹${d.silver_1kg}`:"â‚¹--";
    copper.textContent = d.copper?`â‚¹${d.copper}`:"â‚¹--";
    usd.textContent = d.usd_inr?`â‚¹${d.usd_inr}`:"â‚¹--";
  }catch{}
}

function signal(price,e9,e21,rsi){
  if(e9>e21 && rsi>60) return "BUY";
  if(e9<e21 && rsi<40) return "SELL";
  return "HOLD";
}

function render(){
  time.textContent=new Date().toLocaleTimeString();
  let html="", q=search.value.toLowerCase();
  let rows=[];

  for(let s of STOCKS){
    let d=DB[s]; if(!d||d.length<30) continue;
    if(q && !s.toLowerCase().includes(q)) continue;

    let t=d.at(-1),cl=d.map(x=>x.close);
    let ema9=EMA(cl.slice(-30),9);
    let ema21=EMA(cl.slice(-50),21);
    let rsi=RSI(cl.slice(-15));

    let sup=Math.min(...d.slice(-30).map(x=>x.low));
    let res=Math.max(...d.slice(-30).map(x=>x.high));
    let sig=signal(t.close,ema9,ema21,rsi);

    if(filter==='buy' && sig!=='BUY') continue;
    if(filter==='sell' && sig!=='SELL') continue;

    let sl=sig==="BUY"?sup:res;
    let tgt=sig==="BUY"?t.close+(t.close-sl)*2:t.close-(sl-t.close)*2;

    rows.push({s,t,rsi,ema9,ema21,sup,res,sig,sl,tgt,vol:Math.round(t.volume/100000)});
  }

  for(let r of rows){
    html+=`
    <tr>
      <td class="bold ${r.sig==='BUY'?'green':r.sig==='SELL'?'red':''}">${r.s}</td>
      <td>${r.t.close.toFixed(2)}</td>
      <td class="small">L:${r.t.low.toFixed(1)} H:${r.t.high.toFixed(1)}</td>
      <td class="small">-</td>
      <td>${r.vol}</td>
      <td class="small">-</td>
      <td>${r.rsi.toFixed(1)}</td>
      <td>${r.ema9.toFixed(2)}</td>
      <td>${r.ema21.toFixed(2)}</td>
      <td>${r.sup.toFixed(2)}</td>
      <td>${r.res.toFixed(2)}</td>
      <td>${r.ema9>r.ema21?"Uptrend":"Downtrend"}</td>
      <td class="${r.sig==='BUY'?'green':r.sig==='SELL'?'red':'orange'}">${r.sig}</td>
      <td><button class="tradeBtn" onclick="openTrade('${r.s}',${r.t.close},${r.sl},${r.tgt})">Trade</button></td>
      <td>${r.sl.toFixed(2)}</td>
      <td>${r.tgt.toFixed(2)}</td>
    </tr>`;
  }
  tbody.innerHTML=html;
}

function addStock(){
  let s=newStock.value.trim().toUpperCase();
  if(s && !STOCKS.includes(s)){STOCKS.push(s);loadStock(s);}
  newStock.value="";
}

function takeScreenshot(){
  html2canvas(document.body).then(canvas=>{
    let a=document.createElement("a");
    let d=new Date();
    let name=d.toLocaleTimeString().replace(/:/g,"")+ "_" + d.toLocaleDateString().replace(/\//g,"")+"_STOCKS.png";
    a.download=name;a.href=canvas.toDataURL();a.click();
  });
}

function openTrade(s,e,sl,t){
  let w=window.open();
  w.document.write(`<body style="background:#0b1220;color:white;font-family:sans-serif;padding:20px">
  <h2>${s}</h2>
  Entry: ${e}<br>SL: ${sl}<br>Target: ${t}<br>
  Qty:<input id=q oninput="b.value=(q.value*${e}).toFixed(2)">
  Budget:<input id=b oninput="q.value=Math.floor(b.value/${e})">
  </body>`);
}

async function init(){
  for(let s of STOCKS) await loadStock(s);
  render(); loadMCX();
  setInterval(()=>{render();loadMCX()},60000);
}
init();
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</body>
</html>
