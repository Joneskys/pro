<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Professional Trading Dashboard</title>
<style>
body {
  background: radial-gradient(circle at top, #0c1c3a, #020b1a);
  color: white;
  font-family: Arial, sans-serif;
}
header { font-size:28px; font-weight:bold; padding:20px }
.cards { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; padding:10px }
.card {
  background:linear-gradient(145deg,#0d2448,#051226);
  padding:20px; border-radius:20px; text-align:center;
  box-shadow:0 0 20px #000 inset;
}
.controls { padding:10px; display:flex; gap:8px; flex-wrap:wrap }
input,button,select { background:#071a33;color:white;border:1px solid #1c3b66;padding:8px;border-radius:10px }
table { width:100%; border-collapse:collapse; margin-top:10px }
thead { position:sticky; top:0; background:#061830 }
th,td { padding:8px; text-align:center; border-bottom:1px solid #102a4d }
.buy { color:#00ff99; font-weight:bold }
.sell { color:#ff4444; font-weight:bold }
.hold { color:white }
.up { color:#00ff99 }
.down { color:#ff4444 }
.side { color:orange }
.small { font-size:11px; opacity:0.8 }
.popup { position:fixed; right:20px; bottom:20px; background:#081d3a; padding:15px; border-radius:15px; box-shadow:0 0 20px black }
</style>
</head>
<body>

<header>ðŸ“Š Professional Trading Dashboard</header>

<div class="cards">
  <div class="card"><div>Gold</div><div id="gold">â‚¹--</div></div>
  <div class="card"><div>Silver</div><div id="silver">â‚¹--</div></div>
  <div class="card"><div>Copper</div><div id="copper">â‚¹--</div></div>
  <div class="card"><div>USDINR</div><div id="usd">â‚¹--</div></div>
</div>

<div class="controls">
  <input type="date" id="date">
  <button onclick="refresh()">Submit</button>
  <input placeholder="Search" oninput="search=this.value.toUpperCase();render()">
  <button onclick="filter='BUY';render()">Only Buy</button>
  <button onclick="filter='SELL';render()">Only Sell</button>
  <button onclick="filter='';render()">All</button>
  <select onchange="sort=this.value;render()">
    <option value="">Sort</option>
    <option value="price-desc">Price â†“</option>
    <option value="price-asc">Price â†‘</option>
    <option value="vol-desc">Volume â†“</option>
    <option value="rsi-desc">RSI â†“</option>
  </select>
</div>

<div id="time" style="padding:10px"></div>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th>
<th>Trend</th><th>Signal</th><th>Trade</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<audio id="beep">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const worker="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks=["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let data={},filter="",sort="",search="";
let lastSignal={};

function EMA(arr,n){
  let k=2/(n+1),e=arr[0];
  for(let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k);
  return e;
}
function RSI(c){
  let g=0,l=0;
  for(let i=1;i<c.length;i++){let d=c[i]-c[i-1]; if(d>0)g+=d; else l-=d;}
  let rs=g/(l||1); return 100-(100/(1+rs));
}

async function load(sym){
  const r=await fetch(`${worker}/candles?symbol=${sym}`);
  const j=await r.json();
  const c=Array.isArray(j)?j:j.candles;
  if(!c||!c.length)return;
  const C=c.map(x=>+x.c||+x.close);
  const H=c.map(x=>+x.h||+x.high);
  const L=c.map(x=>+x.l||+x.low);
  const V=c.map(x=>+x.v||+x.volume);
  let live=C.at(-1);
  let ema9=EMA(C,9), ema21=EMA(C,21);
  let rsi=RSI(C);
  let support=Math.min(...L.slice(-20));
  let resist=Math.max(...H.slice(-20));
  let trend=ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
  let signal=rsi>60&&ema9>ema21?"BUY":rsi<40&&ema9<ema21?"SELL":"HOLD";
  if(lastSignal[sym] && lastSignal[sym]!=signal){
    document.getElementById("beep").play();
    alert(sym+" "+signal);
  }
  lastSignal[sym]=signal;
  data[sym]={sym,live,today:`L:${L.at(-1)} H:${H.at(-1)}`,w:`L:${Math.min(...L.slice(-5))} H:${Math.max(...H.slice(-5))}`,
    m:`L:${Math.min(...L.slice(-22))} H:${Math.max(...H.slice(-22))}`,vol:(V.at(-1)/100000).toFixed(0),
    rsi:rsi.toFixed(1),ema9:ema9.toFixed(2),ema21:ema21.toFixed(2),
    support:support.toFixed(2),resist:resist.toFixed(2),
    trend,signal,
    sl:(signal=="BUY"?live*0.985:live*1.015).toFixed(2),
    tgt:(signal=="BUY"?live*1.02:live*0.98).toFixed(2)
  };
}

function render(){
  let arr=Object.values(data);
  if(search) arr=arr.filter(x=>x.sym.includes(search));
  if(filter) arr=arr.filter(x=>x.signal==filter);
  if(sort=="price-desc") arr.sort((a,b)=>b.live-a.live);
  if(sort=="price-asc") arr.sort((a,b)=>a.live-b.live);
  if(sort=="vol-desc") arr.sort((a,b)=>b.vol-a.vol);
  if(sort=="rsi-desc") arr.sort((a,b)=>b.rsi-a.rsi);
  rows.innerHTML=arr.map(x=>`
<tr>
<td style="font-weight:bold;color:${x.signal=="BUY"?"#0f0":x.signal=="SELL"?"#f00":"white"}">${x.sym}</td>
<td>${x.live}</td>
<td class="small">${x.today}</td>
<td class="small">${x.w}</td>
<td>${x.vol}</td>
<td class="small">${x.m}</td>
<td>${x.rsi}</td><td>${x.ema9}</td><td>${x.ema21}</td>
<td>${x.support}</td><td>${x.resist}</td>
<td class="${x.trend=="Uptrend"?"up":x.trend=="Downtrend"?"down":"side"}">${x.trend}</td>
<td class="${x.signal=="BUY"?"buy":x.signal=="SELL"?"sell":"hold"}">${x.signal}</td>
<td><button onclick="trade('${x.sym}',${x.live},${x.sl},${x.tgt})">Trade</button></td>
<td>${x.sl}</td><td>${x.tgt}</td>
</tr>`).join("");
}

function trade(s,e,sl,t){
  window.open(`trade.html?stock=${s}&entry=${e}&sl=${sl}&target=${t}`);
}

async function refresh(){
  for(const s of stocks) await load(s);
  render();
  document.getElementById("time").innerText="Last refresh: "+new Date().toLocaleTimeString();
}
setInterval(refresh,60000);
refresh();

async function loadMCX(){
  const map={gold:"GOLD",silver:"SILVER",copper:"COPPER",usd:"USDINR"};
  for(const id in map){
    try{
      const r=await fetch(`${worker}/mcx?symbol=${map[id]}`);
      const j=await r.json();
      document.getElementById(id).innerText="â‚¹"+j.chart.result[0].meta.regularMarketPrice.toFixed(2);
    }catch{}
  }
}
setInterval(loadMCX,60000);
loadMCX();
</script>
</body>
</html>
