<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Professional Trading Dashboard</title>

<style>
body{
  margin:0;
  background:radial-gradient(circle at top,#0c1d3b,#020b18);
  color:white;
  font-family:Arial, sans-serif;
}
header{padding:20px;font-size:28px;font-weight:bold}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;padding:10px}
.card{
  background:linear-gradient(145deg,#0d2448,#051226);
  border-radius:20px;
  padding:20px;
  text-align:center;
  box-shadow:inset 0 0 20px #000;
}
.controls{display:flex;gap:8px;flex-wrap:wrap;padding:10px}
input,button,select{
  background:#061a33;color:white;border:1px solid #1c3b66;
  padding:8px 12px;border-radius:10px
}
table{width:100%;border-collapse:collapse;margin-top:10px}
thead{background:#071a33;position:sticky;top:0}
th,td{padding:8px;border-bottom:1px solid #102a4d;text-align:center}
.buy{color:#00ff99;font-weight:bold}
.sell{color:#ff4444;font-weight:bold}
.hold{color:#ccc}
.up{color:#00ff99}
.down{color:#ff4444}
.side{color:orange}
.small{font-size:11px;opacity:0.75}
</style>
</head>
<body>

<header>ðŸ“Š Professional Trading Dashboard</header>

<div class="cards">
  <div class="card"><div>Gold</div><div id="gold">â‚¹--</div></div>
  <div class="card"><div>Silver</div><div id="silver">â‚¹--</div></div>
  <div class="card"><div>Copper</div><div id="copper">â‚¹--</div></div>
  <div class="card"><div>USDINR</div><div id="usd">â‚¹--</div></div>
</div>

<div class="controls">
  <input type="date">
  <button onclick="refresh()">Submit</button>
  <input placeholder="Search" oninput="search=this.value.toUpperCase();render()">
  <button onclick="filter='BUY';render()">Only Buy</button>
  <button onclick="filter='SELL';render()">Only Sell</button>
  <button onclick="filter='';render()">All</button>
  <select onchange="sort=this.value;render()">
    <option value="">Sort</option>
    <option value="price-desc">Price â†“</option>
    <option value="price-asc">Price â†‘</option>
    <option value="vol-desc">Volume â†“</option>
    <option value="rsi-desc">RSI â†“</option>
  </select>
</div>

<div id="time" style="padding:10px"></div>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th>
<th>Trend</th><th>Signal</th><th>Trade</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<audio id="beep">
<source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg">
</audio>

<script>
const worker="https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks=["SBIN","TCS","IDEA","RVNL","NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER"];
let data={},filter="",sort="",search="",lastSignal={};

function EMA(arr,n){
  let k=2/(n+1),e=arr[0];
  for(let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k);
  return e;
}
function RSI(c){
  let g=0,l=0;
  for(let i=1;i<c.length;i++){
    let d=c[i]-c[i-1];
    if(d>0) g+=d;
    else l-=d;
  }
  let rs=g/(l||1);
  return 100-(100/(1+rs));
}

async function load(sym){
  const r=await fetch(`${worker}/candles?symbol=${sym}`);
  const j=await r.json();
  const candles=j.candles || j;
  if(!candles || candles.length<30) return;

  const C=candles.map(x=>+x.close);
  const H=candles.map(x=>+x.high);
  const L=candles.map(x=>+x.low);
  const V=candles.map(x=>+x.volume);

  const live=C.at(-1);
  const ema9=EMA(C,9), ema21=EMA(C,21);
  const rsi=RSI(C);

  const support=Math.min(...L.slice(-20));
  const resistance=Math.max(...H.slice(-20));

  const trend=ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
  const signal=rsi>60 && ema9>ema21?"BUY":rsi<40 && ema9<ema21?"SELL":"HOLD";

  const today=`L:${L.at(-1)} H:${H.at(-1)}`;
  const w=`L:${Math.min(...L.slice(-5))} H:${Math.max(...H.slice(-5))}`;
  const m=`L:${Math.min(...L.slice(-22))} H:${Math.max(...H.slice(-22))}`;

  data[sym]={
    sym,live:live.toFixed(2),
    today,w,m,
    vol:(V.at(-1)/100000).toFixed(0),
    rsi:rsi.toFixed(1),
    ema9:ema9.toFixed(2),
    ema21:ema21.toFixed(2),
    support:support.toFixed(2),
    resistance:resistance.toFixed(2),
    trend,signal,
    sl:(signal=="BUY"?live*0.985:live*1.015).toFixed(2),
    tgt:(signal=="BUY"?live*1.02:live*0.98).toFixed(2)
  };
}

function render(){
  let arr=Object.values(data);
  if(search) arr=arr.filter(x=>x.sym.includes(search));
  if(filter) arr=arr.filter(x=>x.signal==filter);

  if(sort=="price-desc") arr.sort((a,b)=>b.live-a.live);
  if(sort=="price-asc") arr.sort((a,b)=>a.live-b.live);
  if(sort=="vol-desc") arr.sort((a,b)=>b.vol-a.vol);
  if(sort=="rsi-desc") arr.sort((a,b)=>b.rsi-a.rsi);

  rows.innerHTML=arr.map(x=>`
<tr>
<td style="font-weight:bold;color:${x.signal=="BUY"?"#0f0":x.signal=="SELL"?"#f00":"white"}">${x.sym}</td>
<td>${x.live}</td>
<td class="small">${x.today}</td>
<td class="small">${x.w}</td>
<td>${x.vol}</td>
<td class="small">${x.m}</td>
<td>${x.rsi}</td><td>${x.ema9}</td><td>${x.ema21}</td>
<td>${x.support}</td><td>${x.resistance}</td>
<td class="${x.trend=="Uptrend"?"up":x.trend=="Downtrend"?"down":"side"}">${x.trend}</td>
<td class="${x.signal=="BUY"?"buy":x.signal=="SELL"?"sell":"hold"}">${x.signal}</td>
<td><button onclick="trade('${x.sym}',${x.live},${x.sl},${x.tgt})">Trade</button></td>
<td>${x.sl}</td><td>${x.tgt}</td>
</tr>`).join("");
}

function trade(s,e,sl,t){
  window.open(`trade.html?stock=${s}&entry=${e}&sl=${sl}&target=${t}`);
}

async function refresh(){
  for(const s of stocks) await load(s);
  render();
  time.innerText="Last refresh: "+new Date().toLocaleTimeString();
}
setInterval(refresh,60000);
refresh();
</script>
</body>
</html>
