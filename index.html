<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Stock Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {background:#020617;color:white;font-family:Arial;margin:0}
header{padding:15px;font-size:24px;font-weight:bold}
.controls{padding:10px;display:flex;gap:10px;flex-wrap:wrap}
input,select,button{
background:#0f2a52;color:white;border:1px solid #1e3a8a;
padding:8px;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:13px}
thead{background:#0b2a55;position:sticky;top:0}
td,th{border-bottom:1px solid #0f2447;padding:6px;text-align:center}
.buy{color:#00ff88;font-weight:bold}
.sell{color:#ff4d4d;font-weight:bold}
.hold{color:#ccc;font-weight:bold}
.up{color:#00ff88}
.down{color:#ff4d4d}
.side{color:orange}
.small{font-size:11px;opacity:.7}
</style>
</head>
<body>

<header>ðŸ“Š Professional Trading Dashboard</header>

<div class="controls">
  <input id="search" placeholder="Search stock" oninput="render()">
  <button onclick="filter='BUY';render()">Only Buy</button>
  <button onclick="filter='SELL';render()">Only Sell</button>
  <button onclick="filter='ALL';render()">All</button>
  <select id="sort" onchange="render()">
    <option value="">Sort</option>
    <option value="priceDesc">Price â†“</option>
    <option value="priceAsc">Price â†‘</option>
    <option value="rsiDesc">RSI â†“</option>
    <option value="rsiAsc">RSI â†‘</option>
    <option value="volDesc">Volume â†“</option>
    <option value="volAsc">Volume â†‘</option>
  </select>
</div>

<p style="padding-left:10px">Last refresh: <span id="time"></span></p>

<table>
<thead>
<tr>
<th>Stock</th><th>Live</th><th>Today</th><th>1W</th><th>Vol(L)</th><th>1M</th>
<th>RSI</th><th>EMA9</th><th>EMA21</th>
<th>Support</th><th>Resistance</th><th>Trend</th>
<th>Signal</th><th>SL</th><th>Target</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
const worker = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
const stocks = ["SBIN","TCS","IDEA","RVNL","JPPOWER","HDFCBANK"];
let store = {};
let filter = "ALL";

function EMA(arr,n){
 let k=2/(n+1),e=arr[0];
 for(let i=1;i<arr.length;i++) e=arr[i]*k+e*(1-k);
 return e;
}
function RSI(arr){
 let g=0,l=0;
 for(let i=1;i<arr.length;i++){
  let d=arr[i]-arr[i-1];
  if(d>0) g+=d; else l-=d;
 }
 let rs=g/(l||1);
 return 100-(100/(1+rs));
}

function normalizeCandles(raw){
 if(Array.isArray(raw)) return raw;
 if(raw.candles) return raw.candles;
 if(raw.data) return raw.data;
 if(raw.result) return raw.result;
 return [];
}

async function loadStock(sym){
 try{
  const r = await fetch(`${worker}/candles?symbol=${sym}`);
  const j = await r.json();

  console.log(sym,"RAW:",j);

  let c = normalizeCandles(j);
  if(!c.length){
    console.warn(sym,"API empty â†’ using mock");
    c = generateMock();
  }

  const cl = c.map(x=>+x.close||+x.c);
  const hi = c.map(x=>+x.high||+x.h);
  const lo = c.map(x=>+x.low||+x.l);
  const vo = c.map(x=>+x.volume||+x.v||100000);

  const live = cl.at(-1);
  const ema9 = EMA(cl.slice(-30),9);
  const ema21 = EMA(cl.slice(-30),21);
  const rsi = RSI(cl.slice(-15));

  const sup = Math.min(...lo.slice(-10));
  const res = Math.max(...hi.slice(-10));

  const trend = ema9>ema21?"Uptrend":ema9<ema21?"Downtrend":"Sideways";
  const signal = (ema9>ema21 && rsi>55)?"BUY":(ema9<ema21 && rsi<45)?"SELL":"HOLD";

  store[sym]={
   sym,live,
   today:`L:${lo.at(-1).toFixed(1)} H:${hi.at(-1).toFixed(1)}`,
   week:`L:${Math.min(...lo.slice(-5)).toFixed(1)} H:${Math.max(...hi.slice(-5)).toFixed(1)}`,
   month:`L:${Math.min(...lo.slice(-22)).toFixed(1)} H:${Math.max(...hi.slice(-22)).toFixed(1)}`,
   vol:(vo.at(-1)/100000).toFixed(0),
   rsi:rsi.toFixed(1),
   ema9:ema9.toFixed(2),
   ema21:ema21.toFixed(2),
   sup:sup.toFixed(2),
   res:res.toFixed(2),
   trend,signal,
   sl:(signal==="BUY"?sup:res).toFixed(2),
   target:(signal==="BUY"? live+(live-sup) : live-(res-live)).toFixed(2)
  };

 }catch(e){console.error(sym,e)}
}

function generateMock(){
 let arr=[],p=100;
 for(let i=0;i<40;i++){
  let o=p+(Math.random()-0.5)*2;
  let h=o+Math.random()*2;
  let l=o-Math.random()*2;
  let c=l+Math.random()*(h-l);
  arr.push({open:o,high:h,low:l,close:c,volume:100000+Math.random()*50000});
  p=c;
 }
 return arr;
}

function render(){
 let arr=Object.values(store);
 const q=document.getElementById("search").value.toUpperCase();
 arr=arr.filter(x=>x.sym.includes(q));
 if(filter!=="ALL") arr=arr.filter(x=>x.signal===filter);

 const s=document.getElementById("sort").value;
 if(s==="priceDesc")arr.sort((a,b)=>b.live-a.live);
 if(s==="priceAsc")arr.sort((a,b)=>a.live-b.live);
 if(s==="rsiDesc")arr.sort((a,b)=>b.rsi-a.rsi);
 if(s==="rsiAsc")arr.sort((a,b)=>a.rsi-b.rsi);
 if(s==="volDesc")arr.sort((a,b)=>b.vol-a.vol);
 if(s==="volAsc")arr.sort((a,b)=>a.vol-b.vol);

 rows.innerHTML = arr.map(s=>`
<tr>
<td class="${s.signal==='BUY'?'buy':s.signal==='SELL'?'sell':'hold'}">${s.sym}</td>
<td>${s.live.toFixed(2)}</td>
<td class="small">${s.today}</td>
<td class="small">${s.week}</td>
<td>${s.vol}</td>
<td class="small">${s.month}</td>
<td>${s.rsi}</td>
<td>${s.ema9}</td>
<td>${s.ema21}</td>
<td>${s.sup}</td>
<td>${s.res}</td>
<td class="${s.trend==='Uptrend'?'up':s.trend==='Downtrend'?'down':'side'}">${s.trend}</td>
<td class="${s.signal==='BUY'?'buy':s.signal==='SELL'?'sell':'hold'}">${s.signal}</td>
<td>${s.sl}</td>
<td>${s.target}</td>
</tr>`).join("");
}

async function refresh(){
 store={};
 for(const s of stocks) await loadStock(s);
 render();
 time.innerText=new Date().toLocaleTimeString();
}

refresh();
setInterval(refresh,60000);
</script>
</body>
</html>
