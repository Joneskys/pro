<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Institutional Trading Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {margin:0;background:#050b1a;color:#fff;font-family:Inter,system-ui;}
header {padding:15px;font-size:20px;font-weight:700;}
.controls {display:flex;flex-wrap:wrap;gap:8px;padding:10px;}
input,button,select {background:#0b1832;border:1px solid #1f2f55;color:#fff;padding:8px;border-radius:8px}
table {width:100%;border-collapse:collapse;font-size:14px;}
th {position:sticky;top:0;background:#081328}
td,th {padding:8px;border-bottom:1px solid #142042;text-align:center}
.buy {background:#05220f}
.sell {background:#2a0505}
.hold {background:#050b1a}
.green{color:#00ff7f}
.red{color:#ff4d4d}
.orange{color:orange}
.small{font-size:11px;opacity:0.7}
.card {background:#071631;padding:15px;border-radius:15px;margin:10px;display:flex;justify-content:space-between}
.alert {position:fixed;right:10px;top:10px;background:#111;padding:10px;border-left:5px solid green;margin-bottom:10px}
</style>
</head>
<body>

<header>ðŸ“Š Institutional Trading Dashboard</header>

<div class="card">
  <div>Gold: â‚¹<span id="gold">--</span></div>
  <div>Silver: â‚¹<span id="silver">--</span></div>
</div>

<div class="controls">
  <input id="search" placeholder="Search stock">
  <button onclick="setFilter('BUY')">Only Buy</button>
  <button onclick="setFilter('SELL')">Only Sell</button>
  <button onclick="setFilter('ALL')">All</button>

  <select onchange="setSort(this.value)">
    <option value="">Sort</option>
    <option value="price">Price High â†’ Low</option>
    <option value="rsi">RSI High â†’ Low</option>
    <option value="volume">Volume High â†’ Low</option>
  </select>

  <input id="newStock" placeholder="Add stock (INFY)">
  <button onclick="addStock()">Add</button>
</div>

<table>
<thead>
<tr>
<th>Stock</th><th>Price</th><th>RSI</th><th>Vol(L)</th>
<th>Signal</th><th>Entry</th><th>SL</th><th>Target</th><th>Trade</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<script>
const worker = "https://red-tooth-e4f7.lovelyideas-in.workers.dev";
let stocks = ["NIFTYBEES","TATAGOLD","TATSILVER","HINDCOPPER","BSE","SAGILITY","CUPID","IDEA","BHARATCOAL","JPPOWER","HDFCBANK","SBIN","MON100","MEESHO","RVNL","ORIENTTECH","HARAFIN","RBLBANK","IRIS","GREAVESCOT","NTPCGREEN","TCS","KIMS"];
let data={}, filter="ALL", sort="";

function round05(n){return Math.round(n*20)/20}

async function fetchStock(sym){
  try{
    const r=await fetch(`${worker}/stock?symbol=${sym}`);
    const j=await r.json();
    return j.price?j:null;
  }catch{return null;}
}

function genMock(sym){
  const price=round05(Math.random()*500+50);
  return {price,rsi:Math.random()*100,vol:Math.floor(Math.random()*200),signal:price%2>1?"BUY":"SELL"}
}

async function load(){
  for(const s of stocks){
    let d=await fetchStock(s);
    if(!d) d=genMock(s);
    data[s]=d;
  }
  render();
}

function render(){
  let rows=[];
  for(const s of stocks){
    let d=data[s]; if(!d)continue;
    if(filter!=="ALL" && d.signal!==filter) continue;
    rows.push({s,...d});
  }

  if(sort==="price") rows.sort((a,b)=>b.price-a.price);
  if(sort==="rsi") rows.sort((a,b)=>b.rsi-a.rsi);
  if(sort==="volume") rows.sort((a,b)=>b.vol-a.vol);

  const html=rows.map(r=>`
    <tr class="${r.signal.toLowerCase()}">
      <td><b>${r.s}</b></td>
      <td>${r.price.toFixed(2)}</td>
      <td>${r.rsi.toFixed(1)}</td>
      <td>${r.vol}</td>
      <td class="${r.signal==="BUY"?"green":"red"}">${r.signal}</td>
      <td>${r.price.toFixed(2)}</td>
      <td>${round05(r.price*0.98).toFixed(2)}</td>
      <td>${round05(r.price*1.02).toFixed(2)}</td>
      <td><button onclick="trade('${r.s}',${r.price})">Trade</button></td>
    </tr>`).join("");
  document.getElementById("body").innerHTML=html;
}

function trade(sym,price){
  const w=window.open();
  w.document.write(`<h2>${sym}</h2>
  <p>Entry: â‚¹${price}</p>
  <p>Qty: <input id='q'></p>
  <p>Budget: <input id='b'></p>
  <script>
  q.oninput=()=>b.value=(q.value*${price}).toFixed(2);
  b.oninput=()=>q.value=Math.floor(b.value/${price});
  </script>`);
}

function addStock(){
  const v=document.getElementById("newStock").value.toUpperCase();
  if(v&&!stocks.includes(v)){stocks.push(v);load();}
}

function setFilter(f){filter=f;render();}
function setSort(s){sort=s;render();}

async function loadMCX(){
  try{
    const g=await fetch(worker+"/mcx?symbol=GOLD").then(r=>r.json());
    const s=await fetch(worker+"/mcx?symbol=SILVER").then(r=>r.json());
    document.getElementById("gold").innerText=g?.chart?.result?.[0]?.meta?.regularMarketPrice?.toFixed(2)||"--";
    document.getElementById("silver").innerText=s?.chart?.result?.[0]?.meta?.regularMarketPrice?.toFixed(2)||"--";
  }catch{}
}

load(); loadMCX(); setInterval(()=>{load();loadMCX()},60000);
</script>
</body>
</html>
